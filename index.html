<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meal Plan Dashboard</title>
    
    <!-- PWA Manifest -->
    <link id="manifest-link" rel="manifest">
    <meta name="theme-color" content="#000000">
    
    <!-- React Libraries -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide-react@0.292.0/dist/umd/lucide-react.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

</head>
<body class="bg-gray-100">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        const { useState, useMemo, useEffect, useRef } = React;
        const { PlusCircle, Trash2, UtensilsCrossed, ShoppingCart, DollarSign, X, Edit, BarChart2, Check, ChevronDown, ChevronUp, ChevronsDown, ChevronsUp } = window.lucide;

        // --- Helper Components ---
        const TabButton = ({ children, onClick, isActive }) => (
          <button
            onClick={onClick}
            className={`flex items-center justify-center w-full px-4 py-3 text-sm font-bold uppercase tracking-wider transition-colors duration-200 focus:outline-none border-b-4 ${
              isActive
                ? 'text-red-600 border-red-600'
                : 'text-gray-500 border-transparent hover:text-black hover:border-gray-300'
            }`}
          >
            {children}
          </button>
        );

        const Card = ({ children, className = '', isCollapsible = true, forceCollapse }) => {
            const [isCollapsed, setIsCollapsed] = useState(false);
            
            useEffect(() => {
                if (forceCollapse !== null) {
                    setIsCollapsed(forceCollapse);
                }
            }, [forceCollapse]);

            const header = React.Children.toArray(children).find(child => child.type === CardHeader);
            const content = React.Children.toArray(children).find(child => child.type === CardContent);
            const summary = React.Children.toArray(children).find(child => child.type === CardSummary);

            return (
                <div className={`bg-white rounded-lg shadow-md border border-gray-200 overflow-hidden ${className}`}>
                    {React.cloneElement(header, { 
                        onClick: isCollapsible ? () => setIsCollapsed(!isCollapsed) : undefined,
                        isCollapsible,
                        isCollapsed
                    })}
                    {isCollapsed && summary}
                    {!isCollapsed && content}
                </div>
            );
        };

        const CardHeader = ({ children, className = '', onClick, isCollapsible, isCollapsed }) => (
            <div className={`px-6 py-4 bg-black flex justify-between items-center ${isCollapsible ? 'cursor-pointer' : ''} ${className}`} onClick={onClick}>
                <div className="flex-grow">{children}</div>
                {isCollapsible && (
                    isCollapsed ? <ChevronDown size={20} className="text-gray-400 ml-4"/> : <ChevronUp size={20} className="text-gray-400 ml-4"/>
                )}
            </div>
        );

        const CardContent = ({ children, className = '' }) => (
            <div className={`p-6 ${className}`}>
                {children}
            </div>
        );

        const CardSummary = ({ children, className = '' }) => (
            <div className={`px-6 py-3 bg-white border-t border-gray-200 ${className}`}>
                {children}
            </div>
        );

        const Modal = ({ children, onClose }) => (
            <div className="fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-50 p-4">
                <div className="bg-white rounded-lg shadow-xl w-full max-w-md border border-gray-300">
                    <div className="flex justify-end p-2 border-b border-gray-200">
                        <button onClick={onClose} className="text-gray-400 hover:text-gray-800">
                            <X size={24} />
                        </button>
                    </div>
                    <div className="p-6">{children}</div>
                </div>
            </div>
        );

        // --- Main App State and Data ---
        const initialPrices = {
            'Chicken Breast': 96.99, 'Rice': 4.17, 'Broccoli': 68.00, 'Olive Oil': 28.75, 
            'Frozen Mixed Veg': 44.00, 'Sweet Chilli Sauce': 3.73, 'Green Beans': 80.00, 
            'Butter': 208.33, 'Garlic': 100.00, 'Jungle Oats': 47.00, 'Greek Yoghurt': 54.67, 
            'Peanut Butter (SF)': 112.50, 'Frozen Banana': 28.67, 'Jersey Milk': 3.50, 'Lemon & Herbs': 5.00,
        };

        const initialIngredientsData = {
            'Chicken Breast': { protein: 31, carbs: 0, fat: { total: 3.6, sat: 1 }, kj: 699 },
            'Rice': { protein: 7, carbs: 80, fat: { total: 0.7, sat: 0.2 }, kj: 1527 },
            'Broccoli': { protein: 2.8, carbs: 6.6, fat: { total: 0.4, sat: 0.1 }, kj: 142 },
            'Olive Oil': { protein: 0, carbs: 0, fat: { total: 100, sat: 14 }, kj: 3701 },
            'Frozen Mixed Veg': { protein: 2.5, carbs: 12, fat: { total: 0.5, sat: 0.1 }, kj: 272 },
            'Sweet Chilli Sauce': { protein: 0.5, carbs: 45, fat: { total: 0.2, sat: 0 }, kj: 765 },
            'Green Beans': { protein: 1.8, carbs: 7, fat: { total: 0.2, sat: 0 }, kj: 130 },
            'Butter': { protein: 0.9, carbs: 0.1, fat: { total: 81, sat: 51 }, kj: 3000 },
            'Garlic': { protein: 6.4, carbs: 33, fat: { total: 0.5, sat: 0.1 }, kj: 623 },
            'Jungle Oats': { protein: 13.5, carbs: 67, fat: { total: 6.5, sat: 1.2 }, kj: 1650 },
            'Greek Yoghurt': { protein: 10, carbs: 4, fat: { total: 5, sat: 3.5 }, kj: 435 },
            'Peanut Butter (SF)': { protein: 25, carbs: 20, fat: { total: 50, sat: 10 }, kj: 2450 },
            'Frozen Banana': { protein: 1.1, carbs: 23, fat: { total: 0.3, sat: 0.1 }, kj: 371 },
            'Jersey Milk': { protein: 3.3, carbs: 4.8, fat: { total: 3.9, sat: 2.4 }, kj: 271 },
            'Lemon & Herbs': { protein: 0, carbs: 0, fat: { total: 0, sat: 0 }, kj: 0 },
        };

        const initialMeals = [
            { id: 'meal1', title: 'Lemon & Herb Chicken', ingredients: [
                { id: 'c1', name: 'Chicken Breast', quantity: 720, unit: 'g' }, { id: 'c2', name: 'Rice', quantity: 900, unit: 'g' },
                { id: 'c3', name: 'Broccoli', quantity: 1000, unit: 'g' }, { id: 'c4', name: 'Olive Oil', quantity: 120, unit: 'ml' },
                { id: 'c5', name: 'Lemon & Herbs', quantity: 1, unit: 'unit' } ] },
            { id: 'meal2', title: 'Sweet Chilli Chicken', ingredients: [
                { id: 'sc1', name: 'Chicken Breast', quantity: 720, unit: 'g' }, { id: 'sc2', name: 'Rice', quantity: 900, unit: 'g' },
                { id: 'sc3', name: 'Frozen Mixed Veg', quantity: 1000, unit: 'g' }, { id: 'sc4', name: 'Olive Oil', quantity: 90, unit: 'ml' },
                { id: 'sc5', name: 'Sweet Chilli Sauce', quantity: 75, unit: 'ml' } ] },
            { id: 'meal3', title: 'Garlic Butter Chicken', ingredients: [
                { id: 'gb1', name: 'Chicken Breast', quantity: 720, unit: 'g' }, { id: 'gb2', name: 'Rice', quantity: 900, unit: 'g' },
                { id: 'gb3', name: 'Green Beans', quantity: 600, unit: 'g' }, { id: 'gb4', name: 'Butter', quantity: 120, unit: 'g' },
                { id: 'gb5', name: 'Olive Oil', quantity: 60, unit: 'ml' }, { id: 'gb6', name: 'Garlic', quantity: 50, unit: 'g' } ] },
        ];

        const initialSmoothie = { id: 'smoothie', title: 'Daily Breakfast Smoothie', ingredients: [
            { id: 's1', name: 'Jungle Oats', quantity: 100, unit: 'g' }, { id: 's2', name: 'Greek Yoghurt', quantity: 150, unit: 'g' },
            { id: 's3', name: 'Peanut Butter (SF)', quantity: 40, unit: 'g' }, { id: 's4', name: 'Frozen Banana', quantity: 150, unit: 'g' },
            { id: 's5', name: 'Jersey Milk', quantity: 200, unit: 'ml' } ] };

        // --- Calculation Logic ---
        const calculateNutrition = (ingredients, ingredientData) => {
            return ingredients.reduce((totals, ing) => {
                const data = ingredientData[ing.name];
                if (!data) return totals;
                const multiplier = ing.quantity / 100;
                totals.protein += data.protein * multiplier;
                totals.carbs += data.carbs * multiplier;
                totals.fat.total += data.fat.total * multiplier;
                totals.fat.sat += data.fat.sat * multiplier;
                totals.kj += data.kj * multiplier;
                return totals;
            }, { protein: 0, carbs: 0, fat: { total: 0, sat: 0 }, kj: 0 });
        };

        // --- App Components ---

        const EditableTitle = ({ initialTitle, onSave }) => {
            const [isEditing, setIsEditing] = useState(false);
            const [title, setTitle] = useState(initialTitle);
            const inputRef = useRef(null);

            useEffect(() => {
                if (isEditing) inputRef.current.focus();
            }, [isEditing]);

            const handleSave = () => {
                onSave(title);
                setIsEditing(false);
            };

            const handleKeyDown = (e) => {
                if (e.key === 'Enter') handleSave();
            };

            if (isEditing) {
                return (
                    <div className="flex items-center">
                        <input
                            ref={inputRef} type="text" value={title}
                            onChange={(e) => setTitle(e.target.value)}
                            onBlur={handleSave} onKeyDown={handleKeyDown}
                            className="text-lg font-bold text-white bg-gray-800 border-b-2 border-red-500 focus:outline-none"
                        />
                         <button onClick={handleSave} className="ml-2 text-green-400 hover:text-green-300"><Check size={20}/></button>
                    </div>
                );
            }

            return (
                <div className="flex items-center cursor-pointer group" onClick={() => setIsEditing(true)}>
                    <h3 className="text-lg font-bold text-white uppercase tracking-wider">{title}</h3>
                    <Edit size={16} className="ml-3 text-gray-400 opacity-0 group-hover:opacity-100 transition-opacity" />
                </div>
            );
        };

        const EditIngredientModal = ({ ingredient, onSave, onClose, ingredientData, setIngredientData }) => {
            const [editedIng, setEditedIng] = useState(ingredient);
            const [editedNutri, setEditedNutri] = useState(ingredientData[ingredient.name] || { protein: 0, carbs: 0, fat: { total: 0, sat: 0 }, kj: 0 });

            const handleSave = () => {
                onSave(editedIng);
                setIngredientData(prev => ({ ...prev, [editedIng.name]: editedNutri }));
                onClose();
            };
            
            const handleNutriChange = (field, value) => setEditedNutri(prev => ({ ...prev, [field]: parseFloat(value) || 0 }));
            const handleFatChange = (field, value) => setEditedNutri(prev => ({ ...prev, fat: { ...prev.fat, [field]: parseFloat(value) || 0 }}));

            return (
                <Modal onClose={onClose}>
                    <h3 className="text-xl font-bold text-gray-800 mb-6 uppercase tracking-wider">Edit {ingredient.name}</h3>
                    <div className="space-y-4">
                        <div>
                            <label className="text-sm font-bold text-gray-600">Quantity</label>
                            <input type="number" value={editedIng.quantity} onChange={e => setEditedIng({...editedIng, quantity: parseFloat(e.target.value) || 0})} className="w-full mt-1 px-3 py-2 bg-gray-100 border border-gray-300 rounded-md text-sm text-gray-800 focus:ring-red-500 focus:border-red-500"/>
                        </div>
                        <h4 className="text-md font-semibold text-gray-800 pt-4 border-t border-gray-200">Nutrition (per 100g/ml)</h4>
                        <div className="grid grid-cols-2 gap-4">
                            <input type="number" placeholder="Protein (g)" value={editedNutri.protein} onChange={e => handleNutriChange('protein', e.target.value)} className="px-3 py-2 bg-gray-100 border border-gray-300 rounded-md text-sm text-gray-800 focus:ring-red-500 focus:border-red-500"/>
                            <input type="number" placeholder="Carbs (g)" value={editedNutri.carbs} onChange={e => handleNutriChange('carbs', e.target.value)} className="px-3 py-2 bg-gray-100 border border-gray-300 rounded-md text-sm text-gray-800 focus:ring-red-500 focus:border-red-500"/>
                            <input type="number" placeholder="Total Fat (g)" value={editedNutri.fat.total} onChange={e => handleFatChange('total', e.target.value)} className="px-3 py-2 bg-gray-100 border border-gray-300 rounded-md text-sm text-gray-800 focus:ring-red-500 focus:border-red-500"/>
                            <input type="number" placeholder="Saturated Fat (g)" value={editedNutri.fat.sat} onChange={e => handleFatChange('sat', e.target.value)} className="px-3 py-2 bg-gray-100 border border-gray-300 rounded-md text-sm text-gray-800 focus:ring-red-500 focus:border-red-500"/>
                            <input type="number" placeholder="Kilojoules (kJ)" value={editedNutri.kj} onChange={e => handleNutriChange('kj', e.target.value)} className="col-span-2 px-3 py-2 bg-gray-100 border border-gray-300 rounded-md text-sm text-gray-800 focus:ring-red-500 focus:border-red-500"/>
                        </div>
                        <button onClick={handleSave} className="w-full bg-red-600 text-white font-bold uppercase tracking-wider rounded-md py-3 hover:bg-red-700 transition-colors">Save Changes</button>
                    </div>
                </Modal>
            );
        };

        const MealCard = ({ meal, prices, onAddIngredient, onRemoveIngredient, onEditIngredient, onUpdateTitle, ingredientData, forceCollapse, isSelected, onSelect }) => {
            const [newItem, setNewItem] = useState({ name: '', quantity: '', unit: 'g' });

            const totalCost = useMemo(() => {
                return meal.ingredients.reduce((acc, ing) => {
                    const price = prices[ing.name] || 0;
                    const priceMultiplier = (ing.unit === 'g' || ing.unit === 'ml') ? ing.quantity / 1000 : ing.quantity;
                    return acc + (price * priceMultiplier);
                }, 0);
            }, [meal.ingredients, prices]);

            const handleAdd = (e) => {
                e.preventDefault();
                if (newItem.name && newItem.quantity > 0) {
                    onAddIngredient(meal.id, { ...newItem, id: Date.now().toString() });
                    setNewItem({ name: '', quantity: '', unit: 'g' });
                }
            };
            
            return (
                <div className="flex items-start gap-4 mb-8">
                     <input type="checkbox" checked={isSelected} onChange={() => onSelect(meal.id)} className="h-5 w-5 text-red-600 border-gray-300 rounded focus:ring-red-500 mt-5"/>
                    <div className="flex-grow">
                        <Card forceCollapse={forceCollapse}>
                            <CardHeader>
                                <div className="flex justify-between items-center w-full">
                                    <EditableTitle initialTitle={meal.title} onSave={(newTitle) => onUpdateTitle(meal.id, newTitle)} />
                                </div>
                            </CardHeader>
                            <CardSummary>
                                 <div className="text-right">
                                    <p className="text-lg font-bold text-gray-800">R{totalCost.toFixed(2)}</p>
                                    <p className="text-xs text-gray-500">{meal.id === 'smoothie' ? 'Cost Per Smoothie' : 'Total Meal Cost (6 Servings)'}</p>
                                </div>
                            </CardSummary>
                            <CardContent>
                                <h4 className="text-sm font-semibold text-gray-600 mb-2 uppercase tracking-wider">Ingredients:</h4>
                                <ul className="divide-y divide-gray-200 mb-4">
                                    {meal.ingredients.map(ing => (
                                        <li key={ing.id} className="py-3 flex justify-between items-center">
                                            <span className="text-sm text-gray-800">{ing.name}</span>
                                            <div className="flex items-center">
                                                <span className="text-sm text-gray-500">{ing.quantity} {ing.unit}</span>
                                                <button onClick={() => onEditIngredient(meal.id, ing.id)} className="ml-4 text-gray-400 hover:text-gray-800"><Edit size={16} /></button>
                                                <button onClick={() => onRemoveIngredient(meal.id, ing.id)} className="ml-2 text-gray-400 hover:text-red-600"><Trash2 size={16} /></button>
                                            </div>
                                        </li>
                                    ))}
                                </ul>
                                <form onSubmit={handleAdd} className="mt-4 pt-4 border-t border-gray-200 border-dashed">
                                    <h4 className="text-sm font-semibold text-gray-600 mb-2 uppercase tracking-wider">Add New Item:</h4>
                                    <div className="grid grid-cols-1 sm:grid-cols-5 gap-2">
                                        <input type="text" placeholder="Ingredient Name" value={newItem.name} onChange={(e) => setNewItem({ ...newItem, name: e.target.value })} className="col-span-2 px-3 py-2 bg-gray-100 border border-gray-300 rounded-md text-sm text-gray-800 focus:ring-red-500 focus:border-red-500"/>
                                        <input type="number" placeholder="Quantity" value={newItem.quantity} onChange={(e) => setNewItem({ ...newItem, quantity: parseFloat(e.target.value) || '' })} className="px-3 py-2 bg-gray-100 border border-gray-300 rounded-md text-sm text-gray-800 focus:ring-red-500 focus:border-red-500"/>
                                         <select value={newItem.unit} onChange={(e) => setNewItem({...newItem, unit: e.target.value})} className="px-3 py-2 bg-gray-100 border border-gray-300 rounded-md text-sm text-gray-800 focus:ring-red-500 focus:border-red-500">
                                            <option value="g">g</option><option value="kg">kg</option><option value="ml">ml</option><option value="L">L</option><option value="unit">unit</option>
                                        </select>
                                        <button type="submit" className="flex items-center justify-center bg-black text-white font-bold uppercase tracking-wider rounded-md hover:bg-gray-800 text-sm py-1 transition-colors"><PlusCircle size={16} className="mr-2"/> Add</button>
                                    </div>
                                </form>
                            </CardContent>
                        </Card>
                    </div>
                </div>
            );
        };

        const MealPlanTab = ({ meals, smoothie, prices, onAddIngredient, onRemoveIngredient, onEditIngredient, onUpdateTitle, onAddNewMeal, onDeleteSelected, ingredientData, forceCollapseAll, selectedMeals, setSelectedMeals }) => {
            const handleSelectMeal = (mealId) => {
                setSelectedMeals(prev => prev.includes(mealId) ? prev.filter(id => id !== mealId) : [...prev, mealId]);
            };

            const handleSelectAll = (e) => {
                if (e.target.checked) {
                    setSelectedMeals([...meals.map(m => m.id), smoothie.id]);
                } else {
                    setSelectedMeals([]);
                }
            };

            return (
                <div>
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-3xl font-bold text-gray-800 uppercase tracking-wider">Meal Plan</h2>
                        <div className="flex items-center gap-2">
                            {selectedMeals.length > 0 && <button onClick={onDeleteSelected} className="flex items-center bg-gray-800 text-white font-bold uppercase tracking-wider rounded-md text-xs py-2 px-3 transition-colors hover:bg-black"><Trash2 size={14} className="mr-2"/>Delete ({selectedMeals.length})</button>}
                            <button onClick={onAddNewMeal} className="flex items-center justify-center bg-red-600 text-white font-bold uppercase tracking-wider rounded-md hover:bg-red-700 text-sm py-2 px-4 transition-colors"><PlusCircle size={16} className="mr-2"/> Add New Meal</button>
                        </div>
                    </div>
                     <div className="flex items-center mb-4 p-2 bg-gray-100 rounded-md">
                        <input type="checkbox" onChange={handleSelectAll} checked={selectedMeals.length === meals.length + 1 && meals.length > 0} className="h-4 w-4 text-red-600 border-gray-300 rounded focus:ring-red-500 mr-4"/>
                        <label className="text-sm font-bold text-gray-600">SELECT ALL</label>
                    </div>
                    <MealCard meal={smoothie} prices={prices} onAddIngredient={onAddIngredient} onRemoveIngredient={onRemoveIngredient} onEditIngredient={onEditIngredient} onUpdateTitle={onUpdateTitle} ingredientData={ingredientData} forceCollapse={forceCollapseAll} isSelected={selectedMeals.includes(smoothie.id)} onSelect={handleSelectMeal}/>
                    {meals.map(meal => (
                        <MealCard key={meal.id} meal={meal} prices={prices} onAddIngredient={onAddIngredient} onRemoveIngredient={onRemoveIngredient} onEditIngredient={onEditIngredient} onUpdateTitle={onUpdateTitle} ingredientData={ingredientData} forceCollapse={forceCollapseAll} isSelected={selectedMeals.includes(meal.id)} onSelect={handleSelectMeal}/>
                    ))}
                </div>
            );
        };

        const MealSummariesTab = ({ meals, smoothie, ingredientData, forceCollapseAll }) => {
            const smoothieNutrition = useMemo(() => calculateNutrition(smoothie.ingredients, ingredientData), [smoothie.ingredients, ingredientData]);

            const dailyTotals = meals.map(meal => {
                const mealNutrition = calculateNutrition(meal.ingredients, ingredientData);
                const total = {
                    protein: smoothieNutrition.protein + (mealNutrition.protein / 3),
                    carbs: smoothieNutrition.carbs + (mealNutrition.carbs / 3),
                    fat: { total: smoothieNutrition.fat.total + (mealNutrition.fat.total / 3) },
                    kj: smoothieNutrition.kj + (mealNutrition.kj / 3),
                };
                total.calories = total.kj / 4.184;
                return { title: meal.title, ...total };
            });

            return (
                <div>
                    <h2 className="text-3xl font-bold text-gray-800 mb-6 uppercase tracking-wider">Meal Summaries</h2>
                    {dailyTotals.map(day => (
                        <Card key={day.title} className="mb-4" forceCollapse={forceCollapseAll}>
                            <CardHeader><h3 className="text-lg font-bold text-white uppercase tracking-wider">{day.title} Day</h3></CardHeader>
                            <CardSummary>
                                <div className="flex justify-around text-center text-xs text-gray-500">
                                    <span>{day.calories.toFixed(0)} kcal</span>
                                    <span>{day.protein.toFixed(0)}g Protein</span>
                                    <span>{day.carbs.toFixed(0)}g Carbs</span>
                                    <span>{day.fat.total.toFixed(0)}g Fat</span>
                                </div>
                            </CardSummary>
                            <CardContent className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div className="text-center p-4 bg-gray-100 rounded-lg"><p className="text-3xl font-bold text-gray-800">{day.calories.toFixed(0)}</p><p className="text-xs text-gray-500 uppercase tracking-wider">Calories (kcal)</p></div>
                                <div className="text-center p-4 bg-gray-100 rounded-lg"><p className="text-3xl font-bold text-gray-800">{day.protein.toFixed(0)}g</p><p className="text-xs text-gray-500 uppercase tracking-wider">Protein</p></div>
                                <div className="text-center p-4 bg-gray-100 rounded-lg"><p className="text-3xl font-bold text-gray-800">{day.carbs.toFixed(0)}g</p><p className="text-xs text-gray-500 uppercase tracking-wider">Carbs</p></div>
                                <div className="text-center p-4 bg-gray-100 rounded-lg"><p className="text-3xl font-bold text-gray-800">{day.fat.total.toFixed(0)}g</p><p className="text-xs text-gray-500 uppercase tracking-wider">Fat</p></div>
                            </CardContent>
                        </Card>
                    ))}
                </div>
            );
        };

        const IngredientsTab = ({ prices, setPrices, ingredientData, setIngredientData, onAddNewIngredient, onRemoveIngredient, meals, smoothie, forceCollapseAll, selectedIngredients, setSelectedIngredients, onDeleteSelected }) => {
            const emptyNutri = { protein: '', carbs: '', fat: { total: '', sat: '' }, kj: '' };
            const [newIngredient, setNewIngredient] = useState({ name: '', price: '', ...emptyNutri });
            
            const handleAdd = (e) => {
                e.preventDefault();
                if (newIngredient.name && !ingredientData.hasOwnProperty(newIngredient.name)) {
                    onAddNewIngredient(newIngredient);
                    setNewIngredient({ name: '', price: '', ...emptyNutri });
                }
            };
            
            const handleInputChange = (field, value) => setNewIngredient(prev => ({ ...prev, [field]: value }));
            const handleFatChange = (field, value) => setNewIngredient(prev => ({ ...prev, fat: { ...prev.fat, [field]: value } }));

            const isIngredientInUse = (name) => {
                const allIngredientsInUse = [
                    ...smoothie.ingredients.map(i => i.name),
                    ...meals.flatMap(m => m.ingredients.map(i => i.name))
                ];
                return allIngredientsInUse.includes(name);
            };
            
            const handleSelect = (name) => {
                setSelectedIngredients(prev => prev.includes(name) ? prev.filter(n => n !== name) : [...prev, name]);
            };
            
            const handleSelectAll = (e) => {
                if (e.target.checked) {
                    setSelectedIngredients(Object.keys(ingredientData));
                } else {
                    setSelectedIngredients([]);
                }
            };

            const handlePriceChange = (name, value) => setPrices(prev => ({ ...prev, [name]: parseFloat(value) || 0 }));
            const handleMasterNutriChange = (name, field, value) => setIngredientData(prev => ({ ...prev, [name]: { ...prev[name], [field]: parseFloat(value) || 0 } }));
            const handleMasterFatChange = (name, field, value) => setIngredientData(prev => ({ ...prev, [name]: { ...prev[name], fat: { ...prev[name].fat, [field]: parseFloat(value) || 0 } } }));
            const getUnitForPrice = (name) => {
                if (name.includes('Sauce') || name.includes('Milk') || name.includes('Oil')) return 'L';
                if (name.includes('Herbs')) return 'unit';
                return 'kg';
            }

            return (
                <div>
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-3xl font-bold text-gray-800 uppercase tracking-wider">Ingredients</h2>
                        {selectedIngredients.length > 0 && <button onClick={onDeleteSelected} className="flex items-center bg-gray-800 text-white font-bold uppercase tracking-wider rounded-md text-xs py-2 px-3 transition-colors hover:bg-black"><Trash2 size={14} className="mr-2"/>Delete ({selectedIngredients.length})</button>}
                    </div>
                    <Card className="mb-6" isCollapsible={false}>
                        <CardHeader><h3 className="font-bold text-white uppercase tracking-wider">Add New Master Ingredient</h3></CardHeader>
                        <CardContent>
                            <form onSubmit={handleAdd} className="space-y-4">
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <input type="text" placeholder="New Ingredient Name" value={newIngredient.name} onChange={e => handleInputChange('name', e.target.value)} className="px-3 py-2 bg-gray-100 border border-gray-300 rounded-md text-sm text-gray-800 focus:ring-red-500 focus:border-red-500"/>
                                    <input type="number" placeholder="Price (per kg/L)" value={newIngredient.price} onChange={e => handleInputChange('price', e.target.value)} className="px-3 py-2 bg-gray-100 border border-gray-300 rounded-md text-sm text-gray-800 focus:ring-red-500 focus:border-red-500"/>
                                </div>
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-4 pt-4 border-t border-gray-200">
                                     <input type="number" placeholder="Protein (g)" value={newIngredient.protein} onChange={e => handleInputChange('protein', e.target.value)} className="px-3 py-2 bg-gray-100 border border-gray-300 rounded-md text-sm text-gray-800 focus:ring-red-500 focus:border-red-500"/>
                                     <input type="number" placeholder="Carbs (g)" value={newIngredient.carbs} onChange={e => handleInputChange('carbs', e.target.value)} className="px-3 py-2 bg-gray-100 border border-gray-300 rounded-md text-sm text-gray-800 focus:ring-red-500 focus:border-red-500"/>
                                     <input type="number" placeholder="Total Fat (g)" value={newIngredient.fat.total} onChange={e => handleFatChange('total', e.target.value)} className="px-3 py-2 bg-gray-100 border border-gray-300 rounded-md text-sm text-gray-800 focus:ring-red-500 focus:border-red-500"/>
                                     <input type="number" placeholder="Sat. Fat (g)" value={newIngredient.fat.sat} onChange={e => handleFatChange('sat', e.target.value)} className="px-3 py-2 bg-gray-100 border border-gray-300 rounded-md text-sm text-gray-800 focus:ring-red-500 focus:border-red-500"/>
                                     <input type="number" placeholder="Kilojoules (kJ)" value={newIngredient.kj} onChange={e => handleInputChange('kj', e.target.value)} className="col-span-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-md text-sm text-gray-800 focus:ring-red-500 focus:border-red-500"/>
                                </div>
                                <button type="submit" className="w-full flex items-center justify-center bg-red-600 text-white font-bold uppercase tracking-wider rounded-md hover:bg-red-700 text-sm py-2 px-4 transition-colors"><PlusCircle size={16} className="mr-2"/> Add Ingredient</button>
                            </form>
                        </CardContent>
                    </Card>
                    <div className="flex items-center mb-4 p-2 bg-gray-100 rounded-md">
                        <input type="checkbox" onChange={handleSelectAll} checked={selectedIngredients.length === Object.keys(ingredientData).length && Object.keys(ingredientData).length > 0} className="h-4 w-4 text-red-600 border-gray-300 rounded focus:ring-red-500 mr-4"/>
                        <label className="text-sm font-bold text-gray-600">SELECT ALL</label>
                    </div>
                    <div className="space-y-4">
                    {Object.keys(ingredientData).map(name => (
                        <Card key={name} forceCollapse={forceCollapseAll}>
                            <CardHeader>
                                <div className="flex justify-between items-center w-full">
                                    <div className="flex items-center">
                                        <input type="checkbox" checked={selectedIngredients.includes(name)} onChange={() => handleSelect(name)} className="h-4 w-4 text-red-600 border-gray-300 rounded focus:ring-red-500 mr-4"/>
                                        <h3 className="font-bold text-white uppercase tracking-wider">{name}</h3>
                                    </div>
                                    {!isIngredientInUse(name) && (
                                        <button onClick={() => onRemoveIngredient(name)} className="text-gray-400 hover:text-red-600"><Trash2 size={18}/></button>
                                    )}
                                </div>
                            </CardHeader>
                            <CardSummary>
                                <div className="text-xs text-gray-500">Price: R{(prices[name] || 0).toFixed(2)} per {getUnitForPrice(name)}</div>
                            </CardSummary>
                            <CardContent>
                                <div className="flex items-center justify-between py-3 border-b border-gray-200">
                                    <label className="text-sm font-medium text-gray-600">Price (per {getUnitForPrice(name)})</label>
                                    <div className="flex items-center">
                                        <span className="text-gray-500 mr-2">R</span>
                                        <input type="number" value={prices[name] || 0} onChange={e => handlePriceChange(name, e.target.value)} className="w-28 text-right px-2 py-1 bg-gray-100 border border-gray-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500 sm:text-sm text-gray-800"/>
                                    </div>
                                </div>
                                <div className="pt-4">
                                    <h4 className="text-sm font-semibold text-gray-600 mb-2 uppercase tracking-wider">Nutrition (per 100g/ml)</h4>
                                    <div className="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
                                        <label className="text-gray-500">Protein:</label> <input type="number" value={ingredientData[name].protein} onChange={e => handleMasterNutriChange(name, 'protein', e.target.value)} className="px-2 py-1 bg-gray-100 border border-gray-300 rounded-md text-gray-800 focus:ring-red-500 focus:border-red-500"/>
                                        <label className="text-gray-500">Carbs:</label> <input type="number" value={ingredientData[name].carbs} onChange={e => handleMasterNutriChange(name, 'carbs', e.target.value)} className="px-2 py-1 bg-gray-100 border border-gray-300 rounded-md text-gray-800 focus:ring-red-500 focus:border-red-500"/>
                                        <label className="text-gray-500">Total Fat:</label> <input type="number" value={ingredientData[name].fat.total} onChange={e => handleMasterFatChange(name, 'total', e.target.value)} className="px-2 py-1 bg-gray-100 border border-gray-300 rounded-md text-gray-800 focus:ring-red-500 focus:border-red-500"/>
                                        <label className="text-gray-500">Sat. Fat:</label> <input type="number" value={ingredientData[name].fat.sat} onChange={e => handleMasterFatChange(name, 'sat', e.target.value)} className="px-2 py-1 bg-gray-100 border border-gray-300 rounded-md text-gray-800 focus:ring-red-500 focus:border-red-500"/>
                                        <label className="text-gray-500">Kilojoules:</label> <input type="number" value={ingredientData[name].kj} onChange={e => handleMasterNutriChange(name, 'kj', e.target.value)} className="px-2 py-1 bg-gray-100 border border-gray-300 rounded-md text-gray-800 focus:ring-red-500 focus:border-red-500"/>
                                    </div>
                                </div>
                            </CardContent>
                        </Card>
                    ))}
                    </div>
                </div>
            );
        };

        const ShoppingListTab = ({ meals, smoothie, prices, forceCollapseAll }) => {
            const monthlyList = useMemo(() => {
                    const shoppingList = {};
                    const mealCycles = { meal1: 3, meal2: 3, meal3: 4 };

                    meals.forEach(meal => {
                        const cycles = mealCycles[meal.id] || 3; // Default to 3 cycles if not specified
                        meal.ingredients.forEach(ing => {
                            if(!shoppingList[ing.name]) shoppingList[ing.name] = {totalQuantity: 0, unit: ing.unit};
                            const quantityInBaseUnit = (ing.unit === 'g' || ing.unit === 'ml') ? ing.quantity / 1000 : ing.quantity;
                            const baseUnit = (ing.unit === 'g') ? 'kg' : (ing.unit === 'ml') ? 'L' : ing.unit;
                            shoppingList[ing.name].totalQuantity += quantityInBaseUnit * cycles;
                            shoppingList[ing.name].unit = baseUnit;
                        });
                    });
                    smoothie.ingredients.forEach(ing => {
                        if(!shoppingList[ing.name]) shoppingList[ing.name] = {totalQuantity: 0, unit: ing.unit};
                        const quantityInBaseUnit = (ing.unit === 'g' || ing.unit === 'ml') ? ing.quantity / 1000 : ing.quantity;
                        const baseUnit = (ing.unit === 'g') ? 'kg' : (ing.unit === 'ml') ? 'L' : ing.unit;
                        shoppingList[ing.name].totalQuantity += quantityInBaseUnit * 30;
                        shoppingList[ing.name].unit = baseUnit;
                    });
                    return shoppingList;
                }, [meals, smoothie]);

                const totalMonthlyCost = useMemo(() => {
                    let cost = 0;
                    Object.entries(monthlyList).forEach(([name, data]) => {
                        cost += (prices[name] || 0) * data.totalQuantity;
                    });
                    return cost;
                }, [monthlyList, prices]);

                return (
                    <div>
                        <h2 className="text-3xl font-bold text-gray-800 mb-6 uppercase tracking-wider">Shopping List</h2>
                         <Card className="mb-6" forceCollapse={forceCollapseAll}>
                            <CardHeader><h3 className="text-lg font-bold text-white uppercase tracking-wider">30-Day Cost Projection</h3></CardHeader>
                            <CardSummary>
                                <div className="text-xs text-gray-500">Total: R{totalMonthlyCost.toFixed(2)}</div>
                            </CardSummary>
                            <CardContent className="space-y-3">
                                <div className="flex justify-between items-center text-lg"><span className="font-medium text-gray-600">Total Monthly Cost:</span><span className="font-bold text-gray-800">R{totalMonthlyCost.toFixed(2)}</span></div>
                                <div className="flex justify-between items-center text-md"><span className="font-medium text-gray-500">Average Weekly Cost:</span><span className="font-bold text-gray-700">R{(totalMonthlyCost / 30 * 7).toFixed(2)}</span></div>
                            </CardContent>
                        </Card>
                        <Card forceCollapse={forceCollapseAll}>
                            <CardHeader><h3 className="text-lg font-bold text-white uppercase tracking-wider">Total Ingredients for 30 Days</h3></CardHeader>
                            <CardSummary>
                                <div className="text-xs text-gray-500">{Object.keys(monthlyList).length} unique items</div>
                            </CardSummary>
                            <CardContent><ul className="divide-y divide-gray-200">{Object.entries(monthlyList).map(([name, data]) => (<li key={name} className="py-3 flex justify-between items-center"><span className="text-sm font-medium text-gray-800">{name}</span><span className="text-sm text-gray-500 font-mono">{data.totalQuantity.toFixed(2)} {data.unit}</span></li>))}</ul></CardContent>
                        </Card>
                    </div>
                );
        };

        const App = () => {
            const [activeTab, setActiveTab] = useState('plan');
            const [meals, setMeals] = useState(initialMeals);
            const [smoothie, setSmoothie] = useState(initialSmoothie);
            const [prices, setPrices] = useState(initialPrices);
            const [ingredientData, setIngredientData] = useState(initialIngredientsData);
            const [editingIngredient, setEditingIngredient] = useState(null);
            const [forceCollapseAll, setForceCollapseAll] = useState(null);
            const [selectedMeals, setSelectedMeals] = useState([]);
            const [selectedIngredients, setSelectedIngredients] = useState([]);

            const handleAddIngredient = (mealId, newIngredient) => {
                if (!prices.hasOwnProperty(newIngredient.name)) {
                    setPrices(prev => ({ ...prev, [newIngredient.name]: 0 }));
                    setIngredientData(prev => ({ ...prev, [newIngredient.name]: { protein: 0, carbs: 0, fat: { total: 0, sat: 0 }, kj: 0 } }));
                }
                const targetStateSetter = mealId === 'smoothie' ? setSmoothie : setMeals;
                targetStateSetter(currentItems => {
                    const updateLogic = item => {
                        if (item.id === mealId) {
                            return { ...item, ingredients: [...item.ingredients, newIngredient] };
                        }
                        return item;
                    };
                    return Array.isArray(currentItems) ? currentItems.map(updateLogic) : updateLogic(currentItems);
                });
            };

            const handleRemoveIngredient = (mealId, ingredientId) => {
                const targetStateSetter = mealId === 'smoothie' ? setSmoothie : setMeals;
                targetStateSetter(currentItems => {
                    const updateLogic = item => {
                        if (item.id === mealId) {
                            return { ...item, ingredients: item.ingredients.filter(ing => ing.id !== ingredientId) };
                        }
                        return item;
                    };
                    return Array.isArray(currentItems) ? currentItems.map(updateLogic) : updateLogic(currentItems);
                });
            };

            const handleUpdateTitle = (mealId, newTitle) => {
                const targetStateSetter = mealId === 'smoothie' ? setSmoothie : setMeals;
                targetStateSetter(currentItems => {
                    const updateLogic = item => {
                        if (item.id === mealId) {
                            return { ...item, title: newTitle };
                        }
                        return item;
                    };
                    return Array.isArray(currentItems) ? currentItems.map(updateLogic) : updateLogic(currentItems);
                });
            };
            
            const handleAddNewMeal = () => {
                const newMeal = {
                    id: `meal${Date.now()}`,
                    title: 'New Meal',
                    ingredients: []
                };
                setMeals(prev => [...prev, newMeal]);
            };
            
            const handleOpenEditModal = (mealId, ingredientId) => {
                const meal = mealId === 'smoothie' ? smoothie : meals.find(m => m.id === mealId);
                const ingredient = meal.ingredients.find(i => i.id === ingredientId);
                setEditingIngredient({mealId, ...ingredient});
            };

            const handleUpdateIngredient = (updatedIngredient) => {
                const { mealId } = editingIngredient;
                const targetStateSetter = mealId === 'smoothie' ? setSmoothie : setMeals;
                targetStateSetter(currentItems => {
                     const updateLogic = item => {
                        if (item.id === mealId) {
                            return { ...item, ingredients: item.ingredients.map(ing => ing.id === updatedIngredient.id ? updatedIngredient : ing) };
                        }
                        return item;
                    };
                    return Array.isArray(currentItems) ? currentItems.map(updateLogic) : updateLogic(currentItems);
                });
            };

            const handleAddNewMasterIngredient = (newIngredient) => {
                const { name, price, ...nutriData } = newIngredient;
                setPrices(prev => ({ ...prev, [name]: parseFloat(price) || 0 }));
                setIngredientData(prev => ({ ...prev, [name]: {
                    protein: parseFloat(nutriData.protein) || 0,
                    carbs: parseFloat(nutriData.carbs) || 0,
                    fat: { 
                        total: parseFloat(nutriData.fat.total) || 0,
                        sat: parseFloat(nutriData.fat.sat) || 0,
                    },
                    kj: parseFloat(nutriData.kj) || 0,
                }}));
            };

            const handleRemoveMasterIngredient = (name) => {
                const newPrices = { ...prices };
                delete newPrices[name];
                setPrices(newPrices);

                const newIngredientData = { ...ingredientData };
                delete newIngredientData[name];
                setIngredientData(newIngredientData);
            };

            const handleBulkDeleteMeals = () => {
                setMeals(prev => prev.filter(m => !selectedMeals.includes(m.id)));
                if (selectedMeals.includes(smoothie.id)) {
                    setSmoothie(prev => ({ ...prev, ingredients: [] }));
                }
                setSelectedMeals([]);
            };

            const handleBulkDeleteIngredients = () => {
                const inUse = new Set([...smoothie.ingredients.map(i => i.name), ...meals.flatMap(m => m.ingredients.map(i => i.name))]);
                const toDelete = selectedIngredients.filter(name => !inUse.has(name));
                
                const newPrices = { ...prices };
                const newIngredientData = { ...ingredientData };
                toDelete.forEach(name => {
                    delete newPrices[name];
                    delete newIngredientData[name];
                });

                setPrices(newPrices);
                setIngredientData(newIngredientData);
                setSelectedIngredients([]);
            };

            const toggleAllCards = (state) => {
                setForceCollapseAll(state);
                setTimeout(() => setForceCollapseAll(null), 100);
            };

            return (
                <div className="bg-gray-100 text-gray-800 min-h-screen font-sans">
                    {editingIngredient && <EditIngredientModal ingredient={editingIngredient} onSave={handleUpdateIngredient} onClose={() => setEditingIngredient(null)} ingredientData={ingredientData} setIngredientData={setIngredientData}/>}
                    <div className="bg-black text-white py-6 mb-8">
                        <div className="container mx-auto px-4 sm:px-6 lg:px-8">
                            <header className="text-center">
                                <h1 className="text-4xl font-black uppercase tracking-widest">Meal Plan Dashboard</h1>
                            </header>
                        </div>
                    </div>
                    
                    <div className="container mx-auto px-4 sm:px-6 lg:px-8">
                        <div className="bg-white shadow-lg mb-8 rounded-lg overflow-hidden">
                            <div className="flex flex-wrap justify-center gap-0">
                                <TabButton onClick={() => setActiveTab('plan')} isActive={activeTab === 'plan'}><UtensilsCrossed size={16} className="mr-2"/> Meal Plan</TabButton>
                                <TabButton onClick={() => setActiveTab('summary')} isActive={activeTab === 'summary'}><BarChart2 size={16} className="mr-2"/> Meal Summaries</TabButton>
                                <TabButton onClick={() => setActiveTab('ingredients')} isActive={activeTab === 'ingredients'}><Edit size={16} className="mr-2"/> Ingredients</TabButton>
                                <TabButton onClick={() => setActiveTab('list')} isActive={activeTab === 'list'}><ShoppingCart size={16} className="mr-2"/> Shopping List</TabButton>
                            </div>
                        </div>

                        <div className="mb-6 flex justify-end gap-2">
                            <button onClick={() => toggleAllCards(false)} className="flex items-center bg-gray-200 text-gray-700 font-bold uppercase tracking-wider rounded-md text-xs py-2 px-3 transition-colors hover:bg-gray-300"><ChevronsDown size={14} className="mr-2"/>Expand All</button>
                            <button onClick={() => toggleAllCards(true)} className="flex items-center bg-gray-200 text-gray-700 font-bold uppercase tracking-wider rounded-md text-xs py-2 px-3 transition-colors hover:bg-gray-300"><ChevronsUp size={14} className="mr-2"/>Collapse All</button>
                        </div>

                        <main>
                            {activeTab === 'plan' && <MealPlanTab meals={meals} smoothie={smoothie} prices={prices} onAddIngredient={handleAddIngredient} onRemoveIngredient={handleRemoveIngredient} onEditIngredient={handleOpenEditModal} onUpdateTitle={handleUpdateTitle} onAddNewMeal={handleAddNewMeal} onDeleteSelected={handleBulkDeleteMeals} ingredientData={ingredientData} forceCollapseAll={forceCollapseAll} selectedMeals={selectedMeals} setSelectedMeals={setSelectedMeals} />}
                            {activeTab === 'summary' && <MealSummariesTab meals={meals} smoothie={smoothie} ingredientData={ingredientData} forceCollapseAll={forceCollapseAll}/>}
                            {activeTab === 'ingredients' && <IngredientsTab prices={prices} setPrices={setPrices} ingredientData={ingredientData} setIngredientData={setIngredientData} onAddNewIngredient={handleAddNewMasterIngredient} onRemoveIngredient={handleRemoveMasterIngredient} meals={meals} smoothie={smoothie} forceCollapseAll={forceCollapseAll} selectedIngredients={selectedIngredients} setSelectedIngredients={setSelectedIngredients} onDeleteSelected={handleBulkDeleteIngredients}/>}
                            {activeTab === 'list' && <ShoppingListTab meals={meals} smoothie={smoothie} prices={prices} forceCollapseAll={forceCollapseAll}/>}
                        </main>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

    </script>
    
    <script>
        // --- PWA Service Worker and Manifest Logic ---
        
        // 1. Dynamically create and link the manifest
        const manifest = {
            "name": "Meal Plan Dashboard",
            "short_name": "MealPlan",
            "start_url": ".",
            "display": "standalone",
            "background_color": "#f3f4f6",
            "theme_color": "#000000",
            "icons": [
                {
                    "src": "https://placehold.co/192x192/ef4444/ffffff?text=M",
                    "type": "image/png",
                    "sizes": "192x192"
                },
                {
                    "src": "https://placehold.co/512x512/ef4444/ffffff?text=MEAL",
                    "type": "image/png",
                    "sizes": "512x512"
                }
            ]
        };
        const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
        const manifestUrl = URL.createObjectURL(manifestBlob);
        document.getElementById('manifest-link').setAttribute('href', manifestUrl);

        // 2. Define and register the service worker
        const swCode = `
            const CACHE_NAME = 'meal-plan-cache-v1';
            const urlsToCache = [
                '/',
                '/index.html',
                'https://unpkg.com/react@18/umd/react.development.js',
                'https://unpkg.com/react-dom@18/umd/react-dom.development.js',
                'https://unpkg.com/@babel/standalone/babel.min.js',
                'https://unpkg.com/lucide-react@0.292.0/dist/umd/lucide-react.js',
                'https://cdn.tailwindcss.com'
            ];

            self.addEventListener('install', event => {
                event.waitUntil(
                    caches.open(CACHE_NAME)
                        .then(cache => {
                            console.log('Opened cache');
                            return cache.addAll(urlsToCache);
                        })
                );
            });

            self.addEventListener('fetch', event => {
                event.respondWith(
                    caches.match(event.request)
                        .then(response => {
                            if (response) {
                                return response;
                            }
                            return fetch(event.request);
                        }
                    )
                );
            });
        `;
        const swBlob = new Blob([swCode], { type: 'application/javascript' });
        const swUrl = URL.createObjectURL(swBlob);

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register(swUrl)
                    .then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch(error => {
                        console.log('ServiceWorker registration failed: ', error);
                    });
            });
        }
    </script>
</body>
</html>
